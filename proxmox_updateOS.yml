tasks:
  - name: Update apt cache
    apt:
      update_cache: yes
    register: apt_update_result

  - name: Upgrade all packages if updates are available
    apt:
      upgrade: dist
    when: apt_update_result.changed

  - name: Remove unnecessary packages if updates are available
    apt:
      autoremove: yes
    when: apt_update_result.changed

  - name: Check if a reboot is needed
    stat:
      path: /var/run/reboot-required
    register: reboot_required

  - name: Trigger reboot if needed
    debug:
      msg: "Reboot required"
    when: reboot_required.stat.exists
    notify: Reboot the system

handlers:
  - name: Reboot the system
    reboot:
